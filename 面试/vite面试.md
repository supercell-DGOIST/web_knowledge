### 前置知识

#### ESM

`ESM`是`JavaScript`提出的官方标准化模块系统，`ESM`提供了更原生以及更动态的模块加载方案，通过import可以直接动态引入需要的模块。

`ESM`的执行可以分为三个步骤：

- 构建: 确定从哪里下载该模块文件、下载并将所有的文件解析为模块记录

- 实例化: 将模块记录转换为一个模块实例，为所有的模块分配内存空间，依照导出、导入语句把模块指向对应的内存地址。

- 运行：运行代码，将内存空间填充

#### Esbuild

`Esbuild`是一个`JavaScript`` Bundler` 打包和压缩工具，可以将`JavaScript` 和`TypeScript`代码打包分发在网页上运行。但其打包速度却是其他工具的10～100倍。

目前他支持以下的功能：

- 加载器

- 压缩

- 打包

- `Tree shaking`

- `Source map`生成

#### Rollup

在生产环境下，`Vite`使用`Rollup`来进行打包

`Rollup`是基于`ESM`的`JavaScript`打包工具。相比于其他打包工具如`Webpack`，他总是能打出更小、更快的包。因为 `Rollup` 基于 `ESM` 模块，比 `Webpack` 和 `Browserify` 使用的 `CommonJS`模块机制更高效。`Rollup`的亮点在于同一个地方，一次性加载。能针对源码进行 `Tree Shaking`(去除那些已被定义但没被使用的代码)，以及 `Scope Hoisting` 以减小输出文件大小提升运行性能。

`Rollup`分为`build`（构建）阶段和`output generate`（输出生成）阶段。主要过程如下：

- 获取入口文件的内容，包装成`module`，生成抽象语法树

- 对入口文件抽象语法树进行依赖解析

- 生成最终代码

- 写入目标文件

##### VS Webapck

`Webpack`是近年来使用量最大，同时社区最完善的前端打包构建工具，新出的`5.x`版本对构建细节进行了优化，在部分场景下打包速度提升明显。`Webpack`在启动时，会先构建项目模块的依赖图，如果在项目中的某个地方改动了代码，`Webpack`则会对相关的依赖重新打包，随着项目的增大，其打包速度也会下降。

`Vite`相比于`Webpack`而言，没有打包的过程，而是直接启动了一个开发服务器devServer。`Vite`劫持浏览器的`HTTP`请求，在后端进行相应的处理将项目中使用的文件通过简单的分解与整合，然后再返回给浏览器(整个过程没有对文件进行打包编译)。所以编译速度很快。

#### 基于ESM的Dev server

``Vite`利用浏览器对`ESM`的支持，当 `import` 模块时，浏览器就会下载被导入的模块。先启动开发服务器，当代码执行到模块加载时再请求对应模块的文件,本质上实现了动态加载。灰色部分是暂时没有用到的路由，所有这部分不会参与构建过程。随着项目里的应用越来越多，增加`route`，也不会影响其构建速度。

##### 热更新核心流程

`Vite`整个热更新过程可以分成四步 

1. 创建一个`websocket`服务端和`client`文件，启动服务

2. 通过`chokidar`监听文件变更

3. 当代码变更后，服务端进行判断并推送到客户端

4. 客户端根据推送的信息执行不同操作的更新

#### 基于esbuild的依赖预编译优化

1、支持commonJS依赖，因为vite基于浏览器原生支持的ESM的能力实现的，所以要求必须是ESM代码模块，因此需要将commonJS的文件提前转换成ESM模块并缓存到node_modules/.vite

2、减少模块和请求数量，vite将内部有许多ESM依赖关系的转成一个模块，提高页面的加载性能。

3、go语言是编译型语言，编译时将语言转换为机械语言，在启动的时候直接执行即可，在 `CPU` 密集场景下，`Go` 更具性能优势，javascript是解释型语言，变运行边解释。go语言支持多线程，webpack没有使用webWorker多线程的功能。

**实现原理**

vite预构建后会将文件缓存在`node_modules/.vite/`文件夹下。会通过一下方式决定时候重新执行预构建：

- `package.json`中：`dependencies`发生变化

- 包管理器的`lockfile`

**优点：**

- 快速的冷启动: 采用`No Bundle`和`esbuild`预构建，速度远快于`Webpack`
- 高效的热更新：基于`ESM`实现，同时利用`HTTP`头来加速整个页面的重新加载，增加缓存策略
- 真正的按需加载: 基于浏览器`ESM`的支持，实现真正的按需加载

**缺点：**

- 生态：目前`Vite`的生态不如`Webapck`，不过我觉得生态也只是时间上的问题。
- 生产环境由于`esbuild`对`css`和代码分割不友好使用`Rollup`进行打包 
